document.addEventListener("DOMContentLoaded", () => {
    const apiBaseUrl = "http://10.220.130.119:9090/api";
    const elements = {
        serialNumbersInput: document.getElementById("sn-input"),
        modelNameField: document.querySelector(".model-name-field"),
        productLineField: document.querySelector(".product-line-field"),
        saveButton: document.getElementById("export-btn"),
        duplicateWarning: document.getElementById("duplicate-warning"),
        exportPerson: document.getElementById("exportPerson")
    };

    // Utility to parse serial numbers
    const parseSerialNumbers = () => elements.serialNumbersInput.value
        .trim()
        .split("\n")
        .map(sn => sn.trim().toUpperCase())
        .filter(sn => sn);

    // Check for duplicate serials
    const hasDuplicates = serials => new Set(serials).size !== serials.length;

    // Show notification using SweetAlert2
    const notify = (type, message) => {
        Swal.fire({
            icon: type,
            text: message,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
    };

    // Fetch product info for serial numbers
    const updateSerialDetails = async serials => {
        const [modelNames, productLines] = [[], []];
        await Promise.all(serials.map(async serial => {
            try {
                const response = await fetch(`${apiBaseUrl}/Product/GetSNInfo?serialNumber=${serial}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        console.error(`API endpoint not found for SN ${serial}`);
                    }
                    modelNames.push("");
                    productLines.push("");
                    return;
                }
                const data = await response.json();
                modelNames.push(data.success ? data.modelName || "" : "");
                productLines.push(data.success ? data.productLine || "" : "");
            } catch (error) {
                console.error(`Error fetching SN ${serial}:`, error);
                modelNames.push("");
                productLines.push("");
            }
        }));
        elements.modelNameField.value = modelNames.join("\n");
        elements.productLineField.value = productLines.join("\n");
    };

    // Save export data
    const saveExportData = async (serials, ignoreNonExisting = false) => {
        const payload = { ExportPerson: elements.exportPerson.value, SerialNumbers: serials };
        try {
            const response = await fetch(`${apiBaseUrl}/Export/ExportSN`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.success) {
                notify("success", `Exported ${data.totalInserted} new serial numbers and updated ${data.totalUpdated}!`);
                if (data.nonExistingSerials?.length) {
                    notify("info", `Non-existing serials exported: ${data.nonExistingSerials.join(", ")}`);
                }
                elements.serialNumbersInput.value = "";
                elements.modelNameField.value = "";
                elements.productLineField.value = "";
                elements.duplicateWarning.style.display = "none";
            } else if (!ignoreNonExisting && data.nonExistingSerials?.length) {
                const confirmContinue = await Swal.fire({
                    title: "Non-existing Serial Numbers",
                    text: `Non-existing serials: ${data.nonExistingSerials.join(", ")}!\nContinue exporting?`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes",
                    cancelButtonText: "No"
                });
                if (confirmContinue.isConfirmed) {
                    await saveExportData(serials, true);
                } else {
                    notify("warning", "Export cancelled!");
                }
            } else {
                notify("error", data.message || "Export failed!");
            }
        } catch (error) {
            console.error("Export error:", error);
            notify("error", "System error!");
        }
    };

    // Handle input changes
    elements.serialNumbersInput.addEventListener("input", async () => {
        const serials = parseSerialNumbers();
        elements.duplicateWarning.style.display = hasDuplicates(serials) ? "block" : "none";
        await updateSerialDetails(serials);
    });

    // Handle export button click with confirmation
    elements.saveButton.addEventListener("click", async () => {
        const serials = parseSerialNumbers();
        if (!serials.length) {
            notify("warning", "Nhập ít nhất 1 SN!");
            return;
        }
        if (hasDuplicates(serials)) {
            notify("warning", "Có SN bị trùng!");
            return;
        }

        // Show confirmation dialog using SweetAlert2
        const confirmExport = await Swal.fire({
            title: "Chức năng chỉ áp dụng cho B36R",
            text: "Bạn có muốn xuất kho?",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Yes",
            cancelButtonText: "No"
        });

        if (confirmExport.isConfirmed) {
            await saveExportData(serials);
        } else {
            notify("warning", "Đã hủy xuất kho!");
        }
    });
});