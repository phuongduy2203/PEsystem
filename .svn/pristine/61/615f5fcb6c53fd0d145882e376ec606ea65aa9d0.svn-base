async function searchSerialNumbers(){const t=document.getElementById("sn-input")?.value||"",n=t.split("\n").map(n=>n.trim().toUpperCase()).filter(n=>n&&/^[A-Za-z0-9-]+$/.test(n));if(n.length===0){showError("Vui lòng nhập ít nhất một Serial Number hợp lệ!");return}try{const i=await fetch("http://10.220.130.119:9090/api/Search/SearchProductsBySN",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok)throw new Error("Không thể tải dữ liệu từ Server");const t=await i.json();console.log(t.success,"hihihihi");t.success?(searchResultsSN=t.results||[],notFoundSerialNumbers=t.notFoundSerialNumbers||[],renderTable(searchResultsSN,"results-body"),displayTotalResults(t.totalFound||0),document.getElementById("search-results").style.display="block",document.getElementById("export-sn-excel-btn").style.display="inline-block",document.getElementById("create-search-list-btn").style.display="inline-block",document.getElementById("export-excel-btn").style.display="none",document.getElementById("button-action").classList.remove("hidden"),showSuccess(`Tìm thấy ${t.totalFound||0}/${t.totalNotFound+t.totalFound||0} SN`)):(showError(t.message||"Không tìm thấy kết quả!"),document.getElementById("create-search-list-btn").style.display="inline-block",searchResultsSN=[],notFoundSerialNumbers=[],renderTable([],"results-body"))}catch(i){showError("Lỗi khi tìm kiếm: "+i.message)}finally{hideSpinner()}}function renderTable(n,t){const i=document.getElementById(t);if(!i){console.error(`Phần tử #${t} không tồn tại!`);return}if(i.innerHTML="",!n||n.length===0){i.innerHTML="<tr><td colspan='22'>Không tìm thấy kết quả!<\/td><\/tr>";return}n.forEach(n=>{const t=`
            <tr>
                <td><input type="checkbox" class="sn-checkbox" data-serial-number="${n.serialNumber||""}"/></td>
                <td>${n.serialNumber||""}</td>
                <td title="${n.productLine||""}">${n.productLine||""}</td>
                <td>${n.modelName||""}</td>
                <td>${n.moNumber||""}</td>
                <td>${n.wipGroup||""}</td>
                <td>${n.workFlag||""}</td>
                <td title="${n.testGroup||""}">${n.testGroup||""}</td>
                <td title="${n.reasonCode||""}">${n.reasonCode||""}</td>
                <td title="${n.testCode||""}">${n.testCode||""}</td>
                <td title="${n.data1||""}">${n.data1||""}</td>
                <td title="${n.kanBanWIP||""}">${n.kanBanWIP||""}</td>
                <td title="${n.holdReason||""}">${n.holdReason||""}</td>
                <td title="${n.blockReason||""}">${n.blockReason||""}</td>
                <td>${n.shelfCode||""}</td>
                <td>${n.columnNumber||""}</td>
                <td>${n.levelNumber||""}</td>
                <td>${n.trayNumber||""}</td>
                <td>${n.positionInTray||""}</td>
                <td>${n.entryDate||""}</td>
                <td title="${n.entryPerson||""}">${n.entryPerson||""}</td>
                <td>${n.borrowStatus||""}</td>
                <td>${n.borrowDate||""}</td>
                <td title="${n.borrowPerson||""}">${n.borrowPerson||""}</td>
                <td title="${n.note||""}">${n.note||""}</td>
                <td title="${n.actionNe||""}">${n.actionNe||""}</td>
                <td title="${n.scrap||""}">${n.scrap||""}</td>
            </tr>`;i.innerHTML+=t})}async function createSearchList(n){n.preventDefault();const t=document.getElementById("entryPerson").value;if(!searchResultsSN||searchResultsSN.length===0){showError("Vui lòng tìm kiếm Serial Number trước khi tạo danh sách!");return}Swal.fire({title:"Tạo danh sách tìm kiếm",input:"text",inputLabel:"Tên danh sách",inputPlaceholder:"Nhập tên danh sách",showCancelButton:!0,confirmButtonText:"Lưu",cancelButtonText:"Hủy",showLoaderOnConfirm:!0,preConfirm:async n=>{if(!n||n.trim()==="")return Swal.showValidationMessage("Vui lòng nhập tên danh sách!"),!1;try{showSpinner();const i=await fetch("http://10.220.130.119:9090/api/Search/SaveSearchList",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({listName:n.trim(),createdBy:t,foundItems:searchResultsSN.map(n=>({serialNumber:n.serialNumber||"",modelName:n.modelName||"",shelfCode:n.shelfCode||"",columnNumber:n.columnNumber||null,levelNumber:n.levelNumber||null,trayNumber:n.trayNumber||null,positionInTray:n.positionInTray||null})),notFoundItems:notFoundSerialNumbers.map(n=>({serialNumber:n||"",modelName:"",shelfCode:"",columnNumber:0,levelNumber:0,trayNumber:0,positionInTray:0}))})});if(!i.ok){const n=await i.json();throw new Error(n.message||"Không thể lưu danh sách!");}return{success:!0}}catch(i){return Swal.showValidationMessage(`Lỗi: ${i.message}`),!1}finally{hideSpinner()}},allowOutsideClick:()=>!Swal.isLoading()}).then(n=>{n.isConfirmed&&n.value.success&&showSuccess("Success!!")})}async function performAdvancedSearch(n=1){showSpinner();const t={BorrowStatus:document.getElementById("borrowStatus")?.value||"",WIPGroup:Array.from(document.getElementById("wipGroup-select")?.selectedOptions||[]).map(n=>n.value),TestCode:document.getElementById("testCode")?.value||"",Data1:document.getElementById("data1")?.value||"",Sfg:Array.from(document.getElementById("modelName-select")?.selectedOptions||[]).map(n=>n.value)};try{const r=await fetch(`${baseUrl}?page=${n}&pageSize=50`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error("Lỗi khi gọi API!");const i=await r.json();i.success&&i.results?.length>0?(searchResults=i.results,renderTable(searchResults,"results-body"),currentPage=i.currentPage||1,totalPages=i.totalPages||1,updatePagination(),displayTotalResults(i.totalItems||0),document.getElementById("search-results").style.display="block",document.getElementById("export-excel-btn").style.display="inline-block",document.getElementById("export-sn-excel-btn").style.display="none",document.getElementById("create-list-sn-btn").style.display="none",document.getElementById("button-action").classList.remove("hidden")):(searchResults=[],renderTable([],"results-body"),displayTotalResults(0),document.getElementById("export-excel-btn").style.display="none",showError(i.message||"Không tìm thấy kết quả!"))}catch(i){showError("Lỗi khi tìm kiếm nâng cao: "+i.message)}finally{hideSpinner()}}function updatePagination(){const n=document.getElementById("pagination-info");if(!n){console.error("Phần tử #pagination-info không tồn tại!");return}n.textContent=`Trang ${currentPage}/${totalPages}`;const t=document.getElementById("prev-page-btn"),i=document.getElementById("next-page-btn");t&&i&&(t.style.display=currentPage>1?"inline-block":"none",i.style.display=currentPage<totalPages?"inline-block":"none")}function displayTotalResults(n){const t=document.getElementById("total-results");if(!t){console.error("Phần tử #total-results không tồn tại!");return}t.textContent=`Kết quả: ${n}`}function changePage(n){const t=currentPage+n;t>=1&&t<=totalPages&&performAdvancedSearch(t)}function exportToExcel(n,t){if(!n||n.length===0){showError("Không có dữ liệu để xuất!");return}const r=n.map(n=>({SERIAL_NUMBER:n.serialNumber||"",PRODUCT_LINE:n.productLine||"",MODEL_NAME:n.modelName||"",MO_NUMBER:n.moNumber||"",WIP_GROUP:n.wipGroup||"",WORK_FLAG:n.workFlag||"",TEST_GROUP:n.testGroup||"","REASON_CODE    ":n.reasonCode||"",TEST_CODE:n.testCode||"",ERROR_DESC:n.data1||"",SHELF:n.shelfCode||"",COLUMN:n.columnNumber||"",LEVEL:n.levelNumber||"",TRAY:n.trayNumber||"",POSITION_IN_TRAY:n.positionInTray||"",ENTRY_DATE:n.entryDate||"",ENTRY_PERSON:n.entryPerson||"",STATUS:n.borrowStatus||"",BORROW_DATE:n.borrowDate||"",BORROW_PERSON:n.borrowPerson||"",NOTE:n.note||"",ACTION:n.actionNe||"",SCRAP:n.scrap||""})),i=XLSX.utils.book_new(),u=XLSX.utils.json_to_sheet(r);XLSX.utils.book_append_sheet(i,u,"Search Results");const f=(new Date).toLocaleString("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).replace(/[,:/]/g,"-");XLSX.writeFile(i,`${t}-${f}.xlsx`)}async function fetchAllPagesParallel(n){const t=await fetch(`${baseUrl}?page=1&pageSize=50`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),i=await t.json(),r=i.totalPages||1,u=Array.from({length:r},(t,i)=>fetch(`${baseUrl}?page=${i+1}&pageSize=50`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(n=>n.json())),f=await Promise.all(u);return f.flatMap(n=>n.success&&n.results?n.results:[])}function setupBorrowFeature(){const n=document.getElementById("borrow-btn"),t=document.getElementById("results-body");t&&n&&(t.addEventListener("change",i=>{i.target.classList.contains("sn-checkbox")&&(selectedSerialNumbers=Array.from(t.querySelectorAll(".sn-checkbox:checked")).map(n=>n.dataset.serialNumber||""),n.disabled=selectedSerialNumbers.length===0)}),n.addEventListener("click",()=>{if(selectedSerialNumbers.length===0){showError("Vui lòng chọn ít nhất một Serial Number!");return}Swal.fire({title:"Xác nhận cho mượn",input:"text",inputLabel:"Tên người mượn",inputPlaceholder:"Nhập tên người mượn",showCancelButton:!0,confirmButtonText:"Xác nhận",cancelButtonText:"Hủy",showLoaderOnConfirm:!0,preConfirm:async n=>{if(!n||n.trim()==="")return Swal.showValidationMessage("Vui lòng nhập tên người mượn!"),!1;try{showSpinner();const t=await fetch("http://10.220.130.119:9090/api/Borrow/Borrow",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Borrower:n.trim(),serialNumbers:selectedSerialNumbers})});if(!t.ok)throw new Error("Lỗi khi gửi yêu cầu mượn");const i=await fetch("http://10.220.130.119:9090/api/RepairStatus/hand-over-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({serialNumbers:selectedSerialNumbers.join(","),handOverStatus:"WAITING_HAND_OVER",tag:"Giao(Cho mượn từ Kho)"})}),r=await i.json();if(r.message.replace(/"/g,"")!=="OK")throw new Error("Lỗi cập nhật trạng thái bàn giao");return{success:!0}}catch(t){return Swal.showValidationMessage(`Lỗi: ${t.message}`),!1}finally{hideSpinner()}},allowOutsideClick:()=>!Swal.isLoading()}).then(n=>{n.isConfirmed&&n.value.success&&(showSuccess("Cho mượn thành công!"),location.reload())})}))}function setupNoteFeature(){const n=document.getElementById("update-note-btn"),t=document.getElementById("results-body");t&&n&&(t.addEventListener("change",i=>{i.target.classList.contains("sn-checkbox")&&(selectedSerialNumbers=Array.from(t.querySelectorAll(".sn-checkbox:checked")).map(n=>n.dataset.serialNumber||""),n.disabled=selectedSerialNumbers.length===0)}),n.addEventListener("click",()=>{if(selectedSerialNumbers.length===0){showError("Vui lòng chọn ít nhất một Serial Number!");return}Swal.fire({title:"Cập nhật ghi chú",input:"textarea",inputLabel:"Nhập ghi chú",inputPlaceholder:"Nhập nội dung...",showCancelButton:!0,confirmButtonText:"Cập nhật",cancelButtonText:"Hủy",showLoaderOnConfirm:!0,inputAttributes:{rows:3},preConfirm:async n=>{if(!n||n.trim()==="")return Swal.showValidationMessage("Vui lòng nhập ghi chú!"),!1;try{showSpinner();const t=await fetch("http://10.220.130.119:9090/api/Product/UpdateProduct",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({serialNumbers:selectedSerialNumbers,note:n.trim()})});if(!t.ok){const n=await t.json();throw new Error(n.message||"Không thể cập nhật ghi chú");}return{success:!0}}catch(t){return Swal.showValidationMessage(`Lỗi: ${t.message}`),!1}finally{hideSpinner()}},allowOutsideClick:()=>!Swal.isLoading()}).then(n=>{n.isConfirmed&&n.value.success&&(showSuccess("Cập nhật ghi chú thành công!"),location.reload())})}))}function setupActionFeature(){const n=document.getElementById("update-action-btn"),t=document.getElementById("results-body");t&&n&&(t.addEventListener("change",i=>{i.target.classList.contains("sn-checkbox")&&(selectedSerialNumbers=Array.from(t.querySelectorAll(".sn-checkbox:checked")).map(n=>n.dataset.serialNumber||""),n.disabled=selectedSerialNumbers.length===0)}),n.addEventListener("click",()=>{if(selectedSerialNumbers.length===0){showError("Vui lòng chọn ít nhất một Serial Number!");return}Swal.fire({title:"Cập nhật Action",input:"textarea",inputLabel:"Nhập action",inputPlaceholder:"Nhập nội dung...",showCancelButton:!0,confirmButtonText:"Cập nhật",cancelButtonText:"Hủy",showLoaderOnConfirm:!0,inputAttributes:{rows:3,maxlength:500},preConfirm:async n=>{if(!n||n.trim()==="")return Swal.showValidationMessage("Vui lòng nhập action!"),!1;try{showSpinner();const t=await fetch("http://10.220.130.119:9090/api/Product/UpdateAction",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({serialNumbers:selectedSerialNumbers,action:n.trim()})});if(!t.ok){const n=await t.json();throw new Error(n.message||"Không thể cập nhật action");}return{success:!0}}catch(t){return Swal.showValidationMessage(`Lỗi: ${t.message}`),!1}finally{hideSpinner()}},allowOutsideClick:()=>!Swal.isLoading()}).then(n=>{n.isConfirmed&&n.value.success&&(showSuccess("Cập nhật action thành công!"),location.reload())})}))}function showSpinner(){document.getElementById("spinner-overlay").style.display="flex"}function hideSpinner(){const n=document.getElementById("spinner-overlay");n&&(n.style.display="none",console.log("Spinner hidden"));const t=document.querySelector(".modal.show");if(t)console.log("Modal still visible, skipping backdrop removal");else{const n=document.querySelector(".modal-backdrop");n&&(n.remove(),console.log("Backdrop removed (no visible modal)"))}}let searchResultsSN=[],notFoundSerialNumbers=[],selectedSerialNumbers=[];document.getElementById("submit-sn-btn").addEventListener("click",searchSerialNumbers);document.getElementById("create-search-list-btn").addEventListener("click",createSearchList);const baseUrl="http://10.220.130.119:9090/api/Search/AdvancedSearch";let currentPage=1,totalPages=1,searchResults=[];document.getElementById("advanced-search-btn").addEventListener("click",()=>performAdvancedSearch());document.getElementById("prev-page-btn").addEventListener("click",()=>changePage(-1));document.getElementById("next-page-btn").addEventListener("click",()=>changePage(1));document.getElementById("export-sn-excel-btn").addEventListener("click",()=>{exportToExcel(searchResultsSN,"SearchResultsSN")});document.getElementById("export-excel-btn").addEventListener("click",async()=>{showSpinner();try{const n={BorrowStatus:document.getElementById("borrowStatus").value,WIPGroup:Array.from(document.getElementById("wipGroup-select").selectedOptions).map(n=>n.value),TestCode:document.getElementById("testCode").value,Data1:document.getElementById("data1").value,Sfg:Array.from(document.getElementById("modelName-select").selectedOptions).map(n=>n.value)},t=await fetchAllPagesParallel(n);exportToExcel(t,"AdvancedSearchResults")}catch(n){showError("Lỗi khi xuất Excel: "+n.message);hideSpinner()}finally{hideSpinner()}});document.addEventListener("DOMContentLoaded",function(){function f(){selectedSerialNumbers=Array.from(t.querySelectorAll(".sn-checkbox:checked")).map(n=>n.dataset.serialNumber||"");i&&(i.disabled=selectedSerialNumbers.length===0);r&&(r.disabled=selectedSerialNumbers.length===0);u&&(u.disabled=selectedSerialNumbers.length===0)}const n=document.getElementById("select-all-checkbox"),t=document.getElementById("results-body"),i=document.getElementById("borrow-btn"),r=document.getElementById("update-note-btn"),u=document.getElementById("update-action-btn");n&&t&&n.addEventListener("change",function(){const i=t.querySelectorAll(".sn-checkbox");i.forEach(t=>{t.checked=n.checked});f()});t&&t.addEventListener("change",function(i){if(i.target.classList.contains("sn-checkbox")){const i=t.querySelectorAll(".sn-checkbox"),r=Array.from(i).every(n=>n.checked),u=Array.from(i).some(n=>n.checked);n&&(n.checked=r,n.indeterminate=!r&&u);f()}});setupBorrowFeature();setupNoteFeature();setupActionFeature();$("#wipGroup-select").select2({placeholder:"WIP Group...",allowClear:!0,width:"100%"}).on("select2:open",function(){console.log("Select2 opened for wipGroup-select")});$("#modelName-select").select2({placeholder:"Model Name",allowClear:!0,width:"100%"}).on("select2:open",function(){});fetch("http://10.220.130.119:9090/api/Search/GetWipGroups").then(n=>{if(!n.ok)throw new Error("API lỗi");return n.json()}).then(n=>{console.log("API data:",n),$("#wipGroup-select").empty(),n.forEach(n=>{$("#wipGroup-select").append(new Option(n,n))}),$("#wipGroup-select").trigger("change")}).catch(n=>console.error("Lỗi API:",n));fetch("http://10.220.130.119:9090/api/Search/ModelName").then(n=>{if(!n.ok)throw new Error("API lỗi");return n.json()}).then(n=>{console.log("API data:",n),$("#modelName-select").empty(),n.forEach(n=>{$("#modelName-select").append(new Option(n,n))}),$("#modelName-select").trigger("change")}).catch(n=>console.error("Lỗi API:",n))});