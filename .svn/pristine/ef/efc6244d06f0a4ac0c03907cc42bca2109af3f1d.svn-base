using API_WEB.ModelsDB;
using API_WEB.ModelsOracle;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Threading.Tasks;

namespace API_WEB.Controllers.Repositories
{
    [Route("api/[controller]")]
    [ApiController]
    public class ExportController : ControllerBase
    {
        private readonly CSDL_NE _sqlContext;
        private readonly OracleDbContext _oracleContext;
        private readonly HttpClient _httpClient;

        public ExportController(CSDL_NE sqlContext, OracleDbContext oracleContext, HttpClient httpClient)
        {
            _sqlContext = sqlContext ?? throw new ArgumentNullException(nameof(sqlContext));
            _oracleContext = oracleContext ?? throw new ArgumentNullException(nameof(oracleContext));
            _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
        }

        [HttpPost("ExportSN")]
        public async Task<IActionResult> Export([FromBody] RequestExport request)
        {
            if (request?.ExportPerson == null || request.SerialNumbers?.Any() != true)
            {
                return BadRequest(new { success = false, message = "Invalid request. ExportPerson and SerialNumbers are required." });
            }

            using var transaction = await _sqlContext.Database.BeginTransactionAsync();
            try
            {
                // Fetch products in bulk
                var serialNumbers = request.SerialNumbers.ToHashSet(StringComparer.OrdinalIgnoreCase);

                // Check existing SNs in Exports table
                var existingExports = await _sqlContext.Exports
                    .Where(e => serialNumbers.Contains(e.SerialNumber))
                    .ToListAsync();
                var existingExportSerials = existingExports.Select(e => e.SerialNumber).ToHashSet(StringComparer.OrdinalIgnoreCase);
                var newSerials = serialNumbers.Except(existingExportSerials, StringComparer.OrdinalIgnoreCase).ToList();

                var now = DateTime.UtcNow;

                // Update existing export entries
                foreach (var export in existingExports)
                {
                    export.EntryPerson = request.ExportPerson;
                    export.ExportPerson = request.ExportPerson;
                    export.EntryDate = now;
                    export.ExportDate = now;
                }

                // Fetch products for new serials
                var productsToExport = await _sqlContext.Products
                    .Where(p => newSerials.Contains(p.SerialNumber))
                    .ToListAsync();

                var existingProductSerials = productsToExport.Select(p => p.SerialNumber).ToHashSet(StringComparer.OrdinalIgnoreCase);
                var nonExistingSerials = newSerials.Except(existingProductSerials, StringComparer.OrdinalIgnoreCase).ToList();

                var exportEntries = new List<Export>(newSerials.Count);

                // New entries from Products table
                exportEntries.AddRange(productsToExport.Select(p => new Export
                {
                    SerialNumber = p.SerialNumber,
                    ExportDate = now,
                    ExportPerson = request.ExportPerson,
                    ProductLine = p.ProductLine,
                    EntryDate = p.EntryDate,
                    EntryPerson = p.EntryPerson,
                    ModelName = p.ModelName
                }));

                // New entries for non-existing serials (fetch ProductLine and ModelName from API)
                if (nonExistingSerials.Any())
                {
                    var snInfoTasks = nonExistingSerials.Select(async sn =>
                    {
                        try
                        {
                            var response = await _httpClient.GetAsync($"http://10.220.130.119:9090/api/Product/GetSNInfo?serialNumber={sn}");
                            if (response.IsSuccessStatusCode)
                            {
                                var data = await response.Content.ReadFromJsonAsync<GetSNInfoResponse>();
                                return (sn, ProductLine: data?.Success == true ? data.ProductLine : null, ModelName: data?.Success == true ? data.ModelName : null);
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error fetching GetSNInfo for SN {sn}: {ex.Message}");
                        }
                        return (sn, ProductLine: null, ModelName: null);
                    });

                    var snInfos = await Task.WhenAll(snInfoTasks);

                    exportEntries.AddRange(snInfos.Select(info => new Export
                    {
                        SerialNumber = info.sn,
                        ExportDate = now,
                        ExportPerson = request.ExportPerson,
                        ProductLine = info.ProductLine,
                        EntryDate = now,
                        EntryPerson = request.ExportPerson,
                        ModelName = info.ModelName
                    }));
                }

                if (!exportEntries.Any() && !existingExports.Any())
                {
                    return BadRequest(new { success = false, message = "No valid serial numbers to export." });
                }

                // Bulk operations
                if (exportEntries.Any())
                {
                    await _sqlContext.Exports.AddRangeAsync(exportEntries);
                }
                if (productsToExport.Any())
                {
                    _sqlContext.Products.RemoveRange(productsToExport);
                }

                await _sqlContext.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new
                {
                    success = true,
                    totalUpdated = existingExports.Count,
                    totalInserted = exportEntries.Count,
                    updatedSerialNumbers = existingExports.Select(e => e.SerialNumber),
                    insertedSerialNumbers = exportEntries.Select(e => e.SerialNumber),
                    nonExistingSerials
                });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                Console.WriteLine($"System Error: {ex.Message}");
                return StatusCode(500, new { success = false, message = "System error occurred." });
            }
        }

        public class RequestExport
        {
            public string? ExportPerson { get; set; }
            public List<string>? SerialNumbers { get; set; }
        }

        public class GetSNInfoResponse
        {
            public bool Success { get; set; }
            public string? ProductLine { get; set; }
            public string? ModelName { get; set; }
        }
    }
}