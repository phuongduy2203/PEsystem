document.addEventListener("DOMContentLoaded", async function () {
    const apiBase = "http://10.220.130.119:9090/api/Bonepile2";
    const apiAgingCountUrl = `${apiBase}/bonepile-after-kanban-aging-count`;
    const apiBasicUrl = `${apiBase}/bonepile-after-kanban-basic`;
    const locationUrl = 'http://10.220.130.119:9090/api/Search/GetLocations';
    // Định nghĩa tất cả trạng thái hợp lệ
    const validStatuses = [
        "ScrapHasTask",
        "ScrapLackTask",
        "WaitingApprovalScrap",
        "ApprovedBGA",
        "WaitingApprovalBGA",
        "RepairInRE",
        "WaitingLink",
        "Linked",
        "Can'tRepairProcess"
    ];

    const statusColorMap = {
        "ScrapHasTask": "#05b529",
        "ScrapLackTask": "#ffc107",
        "WaitingApprovalScrap": "#dc3545",
        "RepairInRE": "#ff8307",
        "ApprovedBGA": "#17b86d",
        "WaitingLink": "#17a2b8"
    };

    let dataTable;
    let modalTable;
    let agingData = [];
    let productLineAgingData = [];
    let productLineChart;
    let basicData;

    // Tạo nội dung ô có tooltip
    function createTooltipCell(data) {
        return `<span class="tooltip-trigger" data-tooltip="${data || ''}">${data || ''}</span>`;
    }

    // Gắn sự kiện tooltip
    function attachTooltipEvents() {
        $(document).on('mouseover', '.tooltip-trigger', function (e) {
            const $this = $(this);
            const tooltipText = $this.data('tooltip');
            if (tooltipText) {
                let tooltip = document.querySelector('.custom-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    document.body.appendChild(tooltip);
                }
                tooltip.textContent = tooltipText;
                tooltip.style.display = 'block';
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY - 20) + 'px';
            }
        }).on('mousemove', '.tooltip-trigger', function (e) {
            const tooltip = document.querySelector('.custom-tooltip');
            if (tooltip && tooltip.style.display === 'block') {
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY - 20) + 'px';
            }
        }).on('mouseout', '.tooltip-trigger', function () {
            const tooltip = document.querySelector('.custom-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        });
    }

    // Load KPI + Donut chart
    async function loadDashboardData() {
        try {
            // Hiển thị spinner
            showSpinner();
            const [basicRes, agingRes] = await Promise.all([
                axios.get(apiBasicUrl),
                axios.get(apiAgingCountUrl)
            ]);
            basicData = basicRes.data || {};
            const { totalCount, statusCounts } = basicData;
            const { agingCounts, agingCountsByProductLine } = agingRes.data;
            agingData = agingCounts;
            productLineAgingData = agingCountsByProductLine || [];

            // Gán KPI
            document.getElementById("totalCount").innerText = totalCount || 0;
            document.getElementById("noTaskScrapCount").innerText = statusCounts.find(s => s.status === "ScrapLackTask")?.count || 0;
            document.getElementById("scrapCount").innerText = statusCounts.find(s => s.status === "ScrapHasTask")?.count || 0;
            document.getElementById("waitingScrapCount").innerText = statusCounts.find(s => s.status === "WaitingApprovalScrap")?.count || 0;
            document.getElementById("repairInRECount").innerText = statusCounts.find(s => s.status === "RepairInRE")?.count || 0;
            document.getElementById("waitingBGACount").innerText = statusCounts.find(s => s.status === "WaitingApprovalBGA")?.count || 0;
            document.getElementById("approvedBGACount").innerText = statusCounts.find(s => s.status === "ApprovedBGA")?.count || 0;
            document.getElementById("notRepairProcessCount").innerText = statusCounts.find(s => s.status === "Can'tRepairProcess")?.count || 0;
            document.getElementById("waitingLinkCount").innerText = statusCounts.find(s => s.status === "WaitingLink")?.count || 0;
            document.getElementById("linkedCount").innerText = statusCounts.find(s => s.status === "Linked")?.count || 0;

            // Tính phần trăm cho biểu đồ
            const total = statusCounts.reduce((sum, s) => sum + s.count, 0);
            const percentages = statusCounts.map(s => total > 0 ? ((s.count / total) * 100).toFixed(1) : 0);

            // Vẽ Donut chart với phần trăm
            const donutCtx = document.getElementById("statusDonutChart").getContext("2d");
            new Chart(donutCtx, {
                type: "doughnut",
                data: {
                    labels: statusCounts.map(s => s.status),
                    datasets: [{
                        data: statusCounts.map(s => s.count),
                        backgroundColor: statusCounts.map(s => statusColorMap[s.status] || "#ccc"),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                boxWidth: 20,
                                boxHeight: 20,
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${percentages[i]}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        lineWidth: 1,
                                        hidden: isNaN(data.datasets[0].data[i]) || data.datasets[0].data[i] === 0,
                                        index: i
                                    }));
                                }
                            },
                            maxWidth: 300,
                            align: "center"
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = percentages[context.dataIndex];
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const total = statusCounts.reduce((sum, d) => sum + d.count, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${percentage}%`;
                            },
                            color: '#000', // Màu chữ
                            font: { weight: 'bold', size: 12 }
                        }

                    }
                },
                plugins: [ChartDataLabels]
            });

            // Tính phần trăm cho biểu đồ aging
            const agingTotal = agingCounts.reduce((sum, a) => sum + a.count, 0);
            const agingPercentages = agingCounts.map(a => agingTotal > 0 ? ((a.count / agingTotal) * 100).toFixed(1) : 0);

            // Vẽ biểu đồ Aging
            const agingCtx = document.getElementById("agingPieChart").getContext("2d");
            const agingChart = new Chart(agingCtx, {
                type: "pie",
                data: {
                    labels: agingCounts.map(a => a.ageRange),
                    datasets: [{
                        data: agingCounts.map(a => a.count),
                        backgroundColor: ["#4e73df", "#1cc88a", "#e74a3b"],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                boxWidth: 20,
                                boxHeight: 20,
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${agingPercentages[i]}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        lineWidth: 1,
                                        hidden: isNaN(data.datasets[0].data[i]) || data.datasets[0].data[i] === 0,
                                        index: i
                                    }));
                                }
                            },
                            align: "center"
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = agingPercentages[context.dataIndex];
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const percentage = agingPercentages[ctx.dataIndex];
                                return `${percentage}%`;
                            },
                            color: '#000',
                            font: { weight: 'bold', size: 12 }
                        }
                    }
                },
                plugins: [ChartDataLabels]

            });

            agingChart.canvas.onclick = function (evt) {
                const points = agingChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                if (points.length) {
                    const index = points[0].index;
                    const label = agingChart.data.labels[index];
                    const records = agingData.find(a => a.ageRange === label)?.records || [];
                    loadTableFromRecords(records);
                }
            };

            renderProductLineAging(productLineAgingData);

            // Load dữ liệu bảng ban đầu (Tất cả trạng thái)
            await loadTableData(validStatuses);
        } catch (error) {
            console.error("Lỗi khi tải dashboard:", error);
            alert("Không thể tải dữ liệu dashboard. Vui lòng thử lại!");
        } finally {
            hideSpinner();
        }
    }

    function renderProductLineAging(data) {
        const tableBody = document.getElementById("productLineAgingTableBody");
        const chartEl = document.getElementById("productLineAgingChart");
        if (!tableBody || !chartEl) return;
        const ctx = chartEl.getContext("2d");
        tableBody.innerHTML = "";
        const labels = [];
        const under45 = [];
        const mid = [];
        const over90 = [];

        const normalizedData = (data || []).map(item => {
            const counts = { "<45": 0, "45-89": 0, ">=90": 0 };
            (item.agingCounts || []).forEach(ac => { counts[ac.ageRange] = ac.count; });
            const total = counts["<45"] + counts["45-89"] + counts[">=90"];
            return {
                productLine: item.productLine || '',
                counts,
                total
            };
        });

        const sortedData = normalizedData.sort((a, b) => b.total - a.total);

        const topProductLines = sortedData.slice(0, 10);
        const remainingProductLines = sortedData.slice(10);

        if (remainingProductLines.length > 0) {
            const aggregatedCounts = remainingProductLines.reduce((acc, item) => {
                acc["<45"] += item.counts["<45"];
                acc["45-89"] += item.counts["45-89"];
                acc[">=90"] += item.counts[">=90"];
                return acc;
            }, { "<45": 0, "45-89": 0, ">=90": 0 });

            const aggregatedTotal = aggregatedCounts["<45"] + aggregatedCounts["45-89"] + aggregatedCounts[">=90"];

            topProductLines.push({
                productLine: "Other",
                counts: aggregatedCounts,
                total: aggregatedTotal
            });
        }

        topProductLines.forEach(item => {
            tableBody.insertAdjacentHTML('beforeend',
                `<tr><td>${item.productLine}</td><td>${item.counts["<45"]}</td><td>${item.counts["45-89"]}</td><td>${item.counts[">=90"]}</td><td>${item.total}</td></tr>`
            );
            labels.push(item.productLine);
            under45.push(item.counts["<45"]);
            mid.push(item.counts["45-89"]);
            over90.push(item.counts[">=90"]);
        });

        if (productLineChart) {
            productLineChart.destroy();
        }

        productLineChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "<45", data: under45, backgroundColor: "#4e73df" },
                    { label: "45-89", data: mid, backgroundColor: "#1cc88a" },
                    { label: ">=90", data: over90, backgroundColor: "#e74a3b" }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    }

    // Load dữ liệu bảng dựa trên trạng thái
    async function loadTableData(statuses, statusesV2) {
        try {
            showSpinner();

            const { data: allData = [], statusDetails = {}, statusDetails_v2 = {} } = basicData || {};

            let tableData = [];
            if (statuses && statuses.length > 0) {
                const filtered = Object.fromEntries(
                    Object.entries(statusDetails).filter(([key]) => statuses.includes(key))
                );
                tableData = Object.values(filtered).flat();
            } else if (statusesV2 && statusesV2.length > 0) {
                const filteredV2 = Object.fromEntries(
                    Object.entries(statusDetails_v2).filter(([key]) => statusesV2.includes(key))
                );
                tableData = Object.values(filteredV2).flat();
            } else {
                tableData = allData;
            }

            const serials = Array.from(new Set(tableData.map(r => r.sn).filter(Boolean)));

            let locationMap = {};
            if (serials.length) {
                try {
                    const [locRes] = await Promise.all([axios.post(locationUrl, serials)]);
                    locationMap = locRes.data?.data || {};
                } catch (err) {
                    console.error('Error fetching locations', err);
                }
            }
            tableData.forEach(r => { r.location = locationMap[r.sn] || ''; });

            if (dataTable) {
                dataTable.clear().rows.add(tableData).draw();
            } else {
                dataTable = $('#sumMaterialsTable').DataTable({
                    data: tableData,
                    scrollX: true,
                    ordering: true,
                    info: true,
                    autoWidth: false,
                    order: [[3, "desc"]],
                    columns: [
                        { data: "sn" },
                        { data: "productLine" },
                        { data: "modelName" },
                        { data: "moNumber" },
                        { data: "wipGroupSFC" },
                        { data: "wipGroupKANBAN" },
                        { data: "errorFlag" },
                        { data: "workFlag" },
                        { data: "testGroup" },
                        { data: "testTime" },
                        { data: "testCode" },
                        { data: "errorCodeItem" },
                        { data: "errorDesc" },
                        { data: "status" },
                        { data: "statusV2" },
                        { data: "aging" },
                        { data: "location" }
                    ],
                    dom: '<"top d-flex align-items-center"flB>rt<"bottom"ip>',

                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: '<img src="/assets/img/excel.png" class="excel-icon excel-button"/>',
                            title: '', // Loại bỏ tiêu đề mặc định
                            filename: function () {
                                const now = new Date();
                                const offset = 7 * 60; // +07:00
                                const localDate = new Date(now.getTime() + offset * 60 * 1000);
                                const dateStr = localDate.toISOString().slice(0, 10).replace(/-/g, '');
                                const timeStr = localDate.toTimeString().slice(0, 8).replace(/:/g, '');
                                return `Bonepile_after_${dateStr}_${timeStr}`;
                            },
                            exportOptions: {
                                columns: ':visible',
                                modifier: {
                                    selected: null
                                },
                                format: {
                                    header: function (data, columnIdx) {
                                        // Loại bỏ khoảng trắng hoặc ký tự không mong muốn
                                        return data.trim();
                                    }
                                }
                            }
                        }
                    ],
                    destroy: true,
                    language: {
                        search: "",
                        emptyTable: "Không có dữ liệu để hiển thị",
                        zeroRecords: "Không tìm thấy bản ghi phù hợp"
                    },
                    initComplete: function () {
                        // Tạo select filter
                        var selectHtml = `
                                                                    <div class="form-group mb-0" style="min-width: 200px;">
                                                                        <select id="statusFilterDt" class="form-control">
                                                                            <option value="">Tất cả</option>
                                                                            <option value="ScrapHasTask">Scrap Has Task</option>
                                                                            <option value="ScrapLackTask">Scrap Lacks Task</option>
                                                                            <option value="WaitingApprovalScrap">Pending Scrap SPE Approval</option>
                                                                            <option value="ApprovedBGA">Approved BGA</option>
                                                                            <option value="WaitingApprovalBGA">Pending BGA SPE Approval</option>
                                                                            <option value="RepairInRE">Repair In RE</option>
                                                                            <option value="WaitingLink">Waiting Link</option>
                                                                            <option value="Linked">Linked</option>
                                                                            <option value="Can'tRepairProcess">Can't Repair Process</option>
                                                                        </select>
                                                                    </div>`;

                        // Chèn vào phần `top` bên trái (trước nút excel)
                        $('.dataTables_wrapper .top').prepend(selectHtml);

                        // Gắn sự kiện
                        $('#statusFilterDt').on('change', async function () {
                            const selectedStatus = this.value;
                            const statuses = selectedStatus ? [selectedStatus] : validStatuses;
                            await loadTableData(statuses);
                        });


                        // Set placeholder cho ô search
                        $('.dataTables_filter input[type="search"]').attr('placeholder', 'Tìm kiếm');
                    }
                });
            }
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu bảng:", error);
            alert("Không thể tải dữ liệu bảng. Vui lòng thử lại!");
        } finally {
            //document.getElementById("spinner-overlay").style.display = "none";
            hideSpinner();
        }
    }

    async function loadTableFromRecords(records) {
        try {
            showSpinner();
            const serials = Array.from(new Set(records.map(r => r.sn).filter(Boolean)));
            let locationMap = {};
            try {
                const locRes = await axios.post(locationUrl, serials);
                locationMap = locRes.data?.data || {};
            } catch (err) {
                console.error('Error fetching locations for modal', err);
            }
            records.forEach(r => { r.location = locationMap[r.sn] || ''; });
            if (modalTable) {
                modalTable.clear().rows.add(records).draw();
                attachTooltipEvents();
            } else {
                modalTable = $('#recordsTable').DataTable({
                    data: records,
                    scrollX: true,
                    searching: true,
                    ordering: false,
                    info: true,
                    columns: [
                        { data: "sn" },
                        { data: "fg" },
                        { data: "productLine" },
                        { data: "modelName" },
                        { data: "moNumber" },
                        { data: "wipGroupSFC" },
                        { data: "wipGroupKANBAN" },
                        { data: "errorFlag" },
                        { data: "workFlag" },
                        { data: "testGroup" },
                        { data: "testTime" },
                        { data: "testCode" },
                        { data: "errorCodeItem" },
                        { data: "errorDesc" },
                        { data: "aging" },
                        { data: "location" }

                    ],
                    columnDefs: [
                        {
                            targets: '_all',
                            width: '120px',
                            render: function (data) { return createTooltipCell(data); }
                        }
                    ],
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: '<img src="/assets/img/excel.png" class="excel-icon excel-button"/>',
                            title: '',
                            filename: function () {
                                const now = new Date();
                                const offset = 7 * 60;
                                const localDate = new Date(now.getTime() + offset * 60 * 1000);
                                const dateStr = localDate.toISOString().slice(0, 10).replace(/-/g, '');
                                const timeStr = localDate.toTimeString().slice(0, 8).replace(/:/g, '');
                                return `Bonepile_after_aging_${dateStr}_${timeStr}`;
                            },
                            exportOptions: { columns: ':visible' }
                        }
                    ],
                    destroy: true,
                    language: {
                        search: '',
                        emptyTable: 'Không có dữ liệu để hiển thị',
                        zeroRecords: 'Không tìm thấy bản ghi phù hợp'
                    }
                });
            }
            const modalEl = document.getElementById('recordsModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
            attachTooltipEvents();
        } finally {
            hideSpinner();
        }
    }

    // Khởi tạo dashboard
    await loadDashboardData();
});