// Cấu hình tập trung
const config = {
    apiBaseUrl: "http://10.220.130.119:9090",
    endpoints: {
        getStatusCounts: "/api/SearchFA/get-status-counts",
        search: "/api/SearchFA/search",
        getFullnameBatch: "/api/SearchFA/get-fullname-batch",
        handOverStatus: "/api/RepairStatus/hand-over-status",
        receivingStatus: "/api/RepairStatus/receiving-status",
        repairStatus: "/api/RepairStatus/repair-status",
        getAllowedAreas: "/api/SearchFA/get-allowed-areas"
    },
    statuses: {
        waitingHandOver: "WAITING_HAND_OVER",
        thayLieu: "THAY LIỆU",
        process: "PROCESS",
        fa: "FA",
        trongRe: "TRONG_RE",
        trongKho: "TRONG_KHO"
    },
    allowedForThayLieu: ["FA", "ARC", "VI_RE", "CHECK_LIST", "RETEST", "BGA", "VI"]
};

// Hàm gọi API chung
async function fetchApi(endpoint, payload) {
    try {
        const response = await fetch(`${config.apiBaseUrl}${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`API call failed: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error(`Error calling ${endpoint}:`, error);
        throw error;
    }
}

// Hàm hiển thị modal nhập vị trí
function showLocationModal(callback) {
    const modalHtml = `
        <div class="modal fade" id="locationModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nhập vị trí</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="locationInput" class="form-control" placeholder="Vị trí (Location)">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" id="confirmLocation">Xác nhận</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingModal = document.getElementById("locationModal");
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML("beforeend", modalHtml);
    const modal = new bootstrap.Modal(document.getElementById("locationModal"));
    modal.show();

    document.getElementById("confirmLocation").addEventListener("click", () => {
        const location = document.getElementById("locationInput").value.trim();
        modal.hide();
        callback(location);
    });
}

// Hàm vẽ biểu đồ
async function drawChart(canvasId, apiPayload, chartTitle, barColor, chartType) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Không tìm thấy canvas với ID '${canvasId}'`);
        return;
    }

    const ctx = canvas.getContext("2d");
    const result = await fetchApi(config.endpoints.getStatusCounts, apiPayload);
    if (result.success) {
        const data = result.data;
        const labels = data.map(item => item.status);
        const counts = data.map(item => item.count);

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "Số lượng trạng thái",
                    data: counts,
                    backgroundColor: barColor,
                    borderColor: barColor.replace("0.8", "1"),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: "top" },
                    title: { display: true, text: chartTitle },
                    datalabels: {
                        anchor: "end",
                        align: "end",
                        color: "black",
                        font: { weight: "bold", size: 12 },
                        formatter: value => value
                    }
                },
                scales: { y: { beginAtZero: true } },
                onClick: async (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const selectedStatus = labels[index];
                        await handleChartClick(selectedStatus, chartType === "handover" ? config.statuses.waitingHandOver : "", chartType);
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
}

// Hàm xử lý click biểu đồ
async function handleChartClick(selectedStatus, handoverStatus, chartType) {
    const payload = {
        serialNumbers: [],
        modelName: "",
        testCode: "",
        status: selectedStatus,
        data1: "",
        handoverStatus,
        location: ""
    };

    try {
        const result = await fetchApi(config.endpoints.search, payload);
        if (result.success) {
            const filteredData = chartType === "online"
                ? result.data.filter(item => item.datA18 !== null && item.datA18 !== config.statuses.trongKho && item.datA13 !== config.statuses.waitingHandOver)
                : result.data;
            updateModalSNTable(filteredData);
            new bootstrap.Modal(document.getElementById("statusModal")).show();
        } else {
            showError(`Không thể tìm thấy dữ liệu cho trạng thái: ${selectedStatus}`);
        }
    } catch (error) {
        showError("Lỗi khi gọi API!");
    }
}

// Hàm cập nhật bảng modal
function updateModalSNTable(data) {
    const table = document.querySelector("#modal-sn-table");
    if (!table) {
        console.error("Không tìm thấy bảng với ID 'modal-sn-table'");
        return;
    }

    if ($.fn.DataTable.isDataTable("#modal-sn-table")) {
        $("#modal-sn-table").DataTable().destroy();
    }

    const tableBody = table.querySelector("tbody") || table.appendChild(document.createElement("tbody"));
    tableBody.innerHTML = "";

    data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td title="${item.seriaL_NUMBER || ''}">${truncateText(item.seriaL_NUMBER, 20)}</td>
            <td title="${item.modeL_NAME || ''}">${truncateText(item.modeL_NAME, 20)}</td>
            <td title="${item.tesT_GROUP || ''}">${truncateText(item.tesT_GROUP, 20)}</td>
            <td title="${item.tesT_CODE || ''}">${truncateText(item.tesT_CODE, 20)}</td>
            <td title="${item.datA1 || ''}">${truncateText(item.datA1, 20)}</td>
            <td>${item.datA12 || ""}</td>
            <td title="${item.datA11 || ''}">${truncateText(item.datA11, 20)}</td>
            <td>${item.tester || ""}</td>
            <td title="${item.datE3 || ''}">${truncateText(item.datE3, 20)}</td>
            <td>${item.datA13 || ""}</td>
            <td>${item.datA18 || ""}</td>
        `;
        tableBody.appendChild(row);
    });

    $("#modal-sn-table").DataTable({
        destroy: true,
        paging: true,
        searching: true,
        ordering: true,
        language: {
            search: "Tìm kiếm:",
            lengthMenu: "Hiển thị _MENU_ dòng",
            info: "Hiển thị _START_ đến _END_ của _TOTAL_ dòng",
            paginate: { first: "Đầu", last: "Cuối", next: "Tiếp", previous: "Trước" }
        }
    });
}

// Hàm vẽ bảng Owner
async function drawOwnerTable() {
    try {
        const result = await fetchApi(config.endpoints.search, {
            serialNumbers: [],
            modelName: "",
            testCode: "",
            status: "",
            data1: "",
            handoverStatus: "",
            location: ""
        });

        if (!result.success) {
            showError(`Không thể lấy dữ liệu từ API: ${result.message}`);
            return;
        }

        const filteredData = result.data.filter(item =>
            item.datA18 !== null && item.datA18 !== config.statuses.trongKho && item.datA13 !== config.statuses.waitingHandOver
        );

        if (!filteredData.length) {
            showError("No data!");
            return;
        }

        const ownerCodes = [...new Set(filteredData.map(item => item.tester).filter(Boolean))];
        const ownerFullNames = (await fetchApi(config.endpoints.getFullnameBatch, ownerCodes)).data || {};

        const ownerSummary = {};
        filteredData.forEach(item => {
            const ownerCode = item.tester || "Unknown";
            const fullName = ownerFullNames[ownerCode] || ownerCode;
            const status = item.datA11 || "Unknown";
            ownerSummary[fullName] = ownerSummary[fullName] || {};
            ownerSummary[fullName][status] = (ownerSummary[fullName][status] || 0) + 1;
        });

        const tableHtml = `
            <table class="table table-bordered">
                <thead><tr><th>Owner (FullName)</th><th>Trạng thái (Online)</th><th>Số lượng</th></tr></thead>
                <tbody>
                    ${Object.entries(ownerSummary).map(([fullName, statuses]) =>
            Object.entries(statuses).map(([status, count]) =>
                `<tr><td class="clickable-owner">${fullName}</td><td>${status}</td><td>${count}</td></tr>`
            ).join("")
        ).join("")}
                </tbody>
            </table>
        `;

        document.getElementById("OwnerTableContainer").innerHTML = tableHtml;

        document.querySelectorAll(".clickable-owner").forEach(cell => {
            cell.addEventListener("click", () => {
                const fullName = cell.textContent.trim();
                const ownerCode = Object.keys(ownerFullNames).find(code => ownerFullNames[code] === fullName) || fullName;
                const ownerData = filteredData.filter(item => item.tester === ownerCode);
                if (ownerData.length) {
                    updateModalSNTable(ownerData);
                    new bootstrap.Modal(document.getElementById("statusModal")).show();
                } else {
                    showError("No data!");
                }
            });
        });
    } catch (error) {
        console.error("Lỗi khi vẽ bảng Owner:", error);
    }
}

// Hàm xử lý Giao Bản
async function handleGiaoBan() {
    const table = $("#sn-table").DataTable();
    const allData = table.rows().data().toArray();
    const currentUser = $("#analysisPerson").val();

    const invalidRecords = allData.filter(row => row[8]?.trim() === config.statuses.waitingHandOver);
    if (invalidRecords.length > 0) {
        showWarning("Có SN ở trạng thái 'WAITING_HAND_OVER'!");
        return;
    }

    const unauthorizedRecords = allData.filter(row => row[6]?.trim() !== currentUser);
    if (unauthorizedRecords.length > 0) {
        showWarning("Bạn không có quyền!");
        return;
    }

    const serialNumbers = allData.map(row => row[0]?.trim()).filter(sn => sn);
    if (!serialNumbers.length) {
        showWarning("Không có dữ liệu hợp lệ để gửi!");
        return;
    }

    const payload = {
        serialnumbers: serialNumbers.join(","),
        handOverStatus: config.statuses.waitingHandOver,
        tag: "giao"
    };

    try {
        const result = await fetchApi(config.endpoints.handOverStatus, payload);
        showInfo(`Cập nhật trạng thái bàn giao: ${result.message}`);
        if (result.message.replace(/"/g, "").trim() === "OK") {
            table.rows().remove().draw();
        }
    } catch (error) {
        showError("Lỗi khi gọi API!");
    }
}

// Hàm xử lý Nhận Bản
async function handleNhanBan() {
    const table = $("#sn-table").DataTable();
    const allData = table.rows().data().toArray();
    const currentUser = $("#analysisPerson").val();

    const invalidRecords = allData.filter(row => row[7]?.trim() !== config.statuses.waitingHandOver);
    if (invalidRecords.length > 0) {
        showWarning("Có SN không ở trạng thái 'WAITING_HAND_OVER'!");
        return;
    }

    const { allowedAreas, unauthorizedRecords } = await checkPermissions(currentUser, allData);
    if (unauthorizedRecords.length > 0) {
        showWarning("Bạn không có quyền nhận bản ở trạng thái hiện tại!");
        return;
    }

    showLocationModal(async (location) => {
        if (!location) {
            showWarning("Vui lòng nhập vị trí (Location)!");
            return;
        }

        const serialNumbers = allData.map(row => row[0]?.trim()).filter(sn => sn);
        if (!serialNumbers.length) {
            showError("Không có dữ liệu hợp lệ để gửi!");
            return;
        }

        const payload = {
            serialnumbers: serialNumbers.join(","),
            type: config.statuses.trongRe,
            owner: currentUser,
            location,
            tag: "nhan"
        };

        try {
            const result = await fetchApi(config.endpoints.receivingStatus, payload);
            showInfo(`Trạng thái nhận bàn giao: ${result.message}`);
            if (result.message.replace(/"/g, "").trim() === "OK") {
                if (allowedAreas.includes(config.statuses.thayLieu)) {
                    const serialsToUpdate = allData
                        .filter(row => config.allowedForThayLieu.includes(row[5]?.trim()))
                        .map(row => ({ serial: row[0]?.trim(), status: row[5]?.trim() }));
                    if (serialsToUpdate.length > 0) {
                        await updateRepairStatusToThayLieu(serialsToUpdate.map(item => item.serial), serialsToUpdate[0].status, currentUser);
                    }
                }

                if (allowedAreas.includes(config.statuses.fa) && allData.some(row => row[5]?.trim() === config.statuses.process)) {
                    await updateRepairStatusToFA(serialNumbers, currentUser);
                }

                table.rows().remove().draw();
            }
        } catch (error) {
            showError("Lỗi khi gọi API!");
        }
    });
}

// Hàm kiểm tra quyền hạn
async function checkPermissions(currentUser, allData) {
    const result = await fetchApi(config.endpoints.getAllowedAreas, { cardCode: currentUser });
    if (!result.success) throw new Error("Không thể lấy quyền truy cập.");

    const allowedAreas = result.allowedAreas.split(",").map(area => area.trim());
    const unauthorizedRecords = allData.filter(row => {
        const status = row[5]?.trim();
        if (allowedAreas.includes(config.statuses.thayLieu) && config.allowedForThayLieu.includes(status)) return false;
        if (status === config.statuses.process && (allowedAreas.includes(config.statuses.fa) || allowedAreas.includes("ARC"))) return false;
        return !allowedAreas.includes(status);
    });

    return { allowedAreas, unauthorizedRecords };
}

// Hàm cập nhật trạng thái THAY LIỆU
async function updateRepairStatusToThayLieu(serialNumbers, status, currentUser) {
    const payload = {
        serialNumbers: serialNumbers.join(","),
        type: status,
        status: config.statuses.thayLieu,
        tag: "confirm",
        notes: "",
        employeeId: currentUser
    };

    const result = await fetchApi(config.endpoints.repairStatus, payload);
    if (result.success && result.message.replace(/"/g, "").trim() === "OK") {
        showInfo("✅ Cập nhật trạng thái thành THAY LIỆU thành công!");
    } else {
        showError("❌ Lỗi cập nhật trạng thái THAY LIỆU!");
    }
}

// Hàm cập nhật trạng thái FA
async function updateRepairStatusToFA(serialNumbers, currentUser) {
    const payload = {
        serialNumbers: serialNumbers.join(","),
        type: config.statuses.process,
        status: config.statuses.fa,
        tag: "confirm",
        notes: "",
        employeeId: currentUser
    };

    const result = await fetchApi(config.endpoints.repairStatus, payload);
    if (result.success && result.message.replace(/"/g, "").trim() === "OK") {
        showInfo("✅ Đã cập nhật trạng thái thành FA thành công!");
    } else {
        showError(`❌ Lỗi cập nhật trạng thái FA: ${result.message}`);
    }
}

// Hàm cắt chuỗi
function truncateText(text, maxLength) {
    return text && text.length > maxLength ? text.substring(0, maxLength) + "..." : text || "";
}

// Khởi tạo khi DOM sẵn sàng
document.addEventListener("DOMContentLoaded", async () => {
    try {
        // Vẽ biểu đồ
        await drawChart("statusChart", "HANDOVER", "Thống Kê Số Lượng bản đang được giao, chờ nhận", "rgba(75, 192, 192, 0.8)", "handover");
        await drawChart("onlineChart", "ONLINE", "Thống Kê Số Lượng Online", "rgba(54, 162, 235, 0.8)", "online");

        // Vẽ bảng Owner
        await drawOwnerTable();

        // Gắn sự kiện Giao/Nhận Bản
        document.getElementById("GiaoBan").addEventListener("click", handleGiaoBan);
        document.getElementById("NhanBan").addEventListener("click", handleNhanBan);

        // Xuất Excel
        document.getElementById("exportExcelBtn").addEventListener("click", () => {
            showSpinner();
            const table = $("#modal-sn-table").DataTable();
            const allData = table.rows().data().toArray();
            if (!allData.length) {
                showError("No data!");
                hideSpinner();
                return;
            }

            const headers = ["Serial Number", "ModelName", "TestGroup", "TestCode", "Data1", "Status", "Date", "ID_Owner", "TimeConfirm", "HandoverStatus", "Locaton"];
            const rows = allData.map(row => headers.map((_, i) => row[i]));
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            XLSX.utils.book_append_sheet(workbook, worksheet, "DanhSachSN");
            XLSX.writeFile(workbook, "Danh_Sach_Serial_Numbers.xlsx");
            hideSpinner();
        });
    } catch (error) {
        console.error("Lỗi khi khởi tạo:", error);
    }
});

// Xử lý form SN với jQuery
$(document).ready(function () {
    const table = $("#sn-table").DataTable({
        dom: "t",
        paging: false,
        info: false,
        scrollX: true,
        destroy: true
    });
    const existingSNs = new Set();

    $("#sn-form").on("submit", async function (e) {
        e.preventDefault();
        const serialNumber = $("#serialNumber").val().trim();
        if (!serialNumber) {
            showWarning("Vui lòng nhập SN!");
            return;
        }
        if (existingSNs.has(serialNumber)) {
            showWarning(`"${serialNumber}" đã tồn tại!`);
            return;
        }

        try {
            const result = await fetchApi(config.endpoints.search, {
                serialNumbers: [serialNumber],
                modelName: "",
                testCode: "",
                status: "",
                data1: "",
                HandoverStatus: "",
            });

            if (result.success && Array.isArray(result.data)) {
                result.data.forEach(item => {
                    const sn = item.seriaL_NUMBER?.trim() || "";
                    if (!sn) return;
                    existingSNs.add(sn);
                    table.row.add([
                        sn,
                        item.modeL_NAME || "",
                        `<span title="${item.tesT_CODE || ''}">${item.tesT_CODE || ''}</span>`,
                        `<span title="${item.datA1 || ''}">${item.datA1 || ''}</span>`,
                        item.wiP_GROUP || "",
                        item.datA11 || "",
                        item.tester || "",
                        item.datA13 || "",
                        item.datA18 || "",
                        `<button class="btn btn-success btn-delete">Xóa</button>`
                    ]).draw(false);
                });
                $("#sn-form")[0].reset();
            }
        } catch (error) {
            showError("Lỗi khi gọi API!");
        }
    });

    $("#sn-table tbody").on("click", ".btn-delete", function () {
        const row = table.row($(this).parents("tr"));
        existingSNs.delete(row.data()[0]?.trim());
        row.remove().draw();
    });
});

// Hàm hiển thị thông báo (giả định)
function showError(message) { console.error(message); alert(message); }
function showWarning(message) { console.warn(message); alert(message); }
function showInfo(message) { console.info(message); alert(message); }
function showSpinner() { document.getElementById("spinner-overlay").style.display = "flex"; }
function hideSpinner() { document.getElementById("spinner-overlay").style.display = "none"; }