@* File: Index.cshtml *@
@{
    ViewData["Title"] = "Material Area";
    Layout = "~/Areas/MaterialSystem/views/Shared/Layout_material.cshtml";
}

    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
        <h1 class="text-2xl font-bold mb-4 text-center">Tìm kiếm thông tin thiết bị</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="serialNumber" class="block text-sm font-medium text-gray-700">Serial Number (var_1)</label>
                <input type="text" id="serialNumber" class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập Serial Number">
            </div>
            <div>
                <label for="refDes" class="block text-sm font-medium text-gray-700">Reference Designator (var_2)</label>
                <input type="text" id="refDes" class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập Ref Des">
            </div>
        </div>

        <button onclick="search()" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition duration-200">Tìm kiếm</button>

        <div class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Kết quả GET_DC_LC</h2>
            <div class="overflow-x-auto">
                <table id="dcLcTable" class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border border-gray-300 p-2">P_SN</th>
                            <th class="border border-gray-300 p-2">WO</th>
                            <th class="border border-gray-300 p-2">P_NO</th>
                            <th class="border border-gray-300 p-2">TR_SN</th>
                            <th class="border border-gray-300 p-2">KP_NO</th>
                            <th class="border border-gray-300 p-2">MFR_KP_NO</th>
                            <th class="border border-gray-300 p-2">DATE_CODE</th>
                            <th class="border border-gray-300 p-2">LOT_CODE</th>
                            <th class="border border-gray-300 p-2">MFR_NAME</th>
                            <th class="border border-gray-300 p-2">REF_DES</th>
                        </tr>
                    </thead>
                    <tbody id="dcLcTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Kết quả tìm kiếm theo Mã Liệu</h2>
            <div class="overflow-x-auto">
                <table id="materialTable" class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border border-gray-300 p-2">Mã Liệu</th>
                            <th class="border border-gray-300 p-2">Nhà Cung Ứng</th>
                            <th class="border border-gray-300 p-2">Date Code</th>
                            <th class="border border-gray-300 p-2">Lot Code</th>
                            <th class="border border-gray-300 p-2">Tổng Linh</th>
                            <th class="border border-gray-300 p-2">Số Lượng OK</th>
                            <th class="border border-gray-300 p-2">Số Lượng NG</th>
                            <th class="border border-gray-300 p-2">Cho Mượn</th>
                            <th class="border border-gray-300 p-2">Đã Báo Phế</th>
                            <th class="border border-gray-300 p-2">ESD</th>
                            <th class="border border-gray-300 p-2">Vị trí</th>
                            <th class="border border-gray-300 p-2">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="materialTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

@section Scripts {
        <script>
            async function search() {
                const serialNumber = document.getElementById('serialNumber').value;
                const refDes = document.getElementById('refDes').value;

                if (!serialNumber || !refDes) {
                    alert('Vui lòng nhập đầy đủ Serial Number và Reference Designator!');
                    return;
                }

                // Xóa bảng cũ
                document.getElementById('dcLcTableBody').innerHTML = '';
                document.getElementById('materialTableBody').innerHTML = '';

                try {
                    // Gọi API GET_DC_LC
                    const dcLcResponse = await fetch('https://vnmbd-apapi-cns.myfiinet.com/all_api/api/public/table', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type: 'GET_DC_LC',
                            item: 'BY-RE-SN',
                            var_1: serialNumber,
                            var_2: refDes
                        })
                    });

                    if (!dcLcResponse.ok) {
                        throw new Error('Lỗi khi gọi API GET_DC_LC');
                    }

                    const dcLcData = await dcLcResponse.json();
                    const results = dcLcData.result;

                    if (!results || results.length === 0) {
                        alert('Không tìm thấy dữ liệu từ API GET_DC_LC!');
                        return;
                    }

                    // Hiển thị dữ liệu vào bảng GET_DC_LC
                    const dcLcTableBody = document.getElementById('dcLcTableBody');
                    results.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                                            <td class="border border-gray-300 p-2">${item.P_SN}</td>
                                            <td class="border border-gray-300 p-2">${item.WO}</td>
                                            <td class="border border-gray-300 p-2">${item.P_NO}</td>
                                            <td class="border border-gray-300 p-2">${item.TR_SN}</td>
                                            <td class="border border-gray-300 p-2">${item.KP_NO}</td>
                                            <td class="border border-gray-300 p-2">${item.MFR_KP_NO}</td>
                                            <td class="border border-gray-300 p-2">${item.DATE_CODE}</td>
                                            <td class="border border-gray-300 p-2">${item.LOT_CODE}</td>
                                            <td class="border border-gray-300 p-2">${item.MFR_NAME}</td>
                                            <td class="border border-gray-300 p-2">${item.REF_DES}</td>
                                        `;
                        dcLcTableBody.appendChild(row);
                    });

                    // Lấy KP_NO từ kết quả đầu tiên để gọi API SearchByMaLieu
                    const kpNo = results[0].KP_NO;

                    // Gọi API SearchByMaLieu
                    const materialResponse = await fetch('http://localhost:5025/api/MaterialSystem/SearchByMaLieu', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            MaLieu: kpNo
                        })
                    });

                    if (!materialResponse.ok) {
                        throw new Error('Lỗi khi gọi API SearchByMaLieu');
                    }

                    const materialData = await materialResponse.json();

                    if (!materialData || materialData.length === 0) {
                        alert('Không tìm thấy dữ liệu từ API SearchByMaLieu!');
                        return;
                    }

                    // Hiển thị dữ liệu vào bảng Mã Liệu
                    const materialTableBody = document.getElementById('materialTableBody');
                    materialData.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                                            <td class="border border-gray-300 p-2">${item.MA_LIEU}</td>
                                            <td class="border border-gray-300 p-2">${item.NHA_CUNG_UNG}</td>
                                            <td class="border border-gray-300 p-2">${item.DATE_CODE}</td>
                                            <td class="border border-gray-300 p-2">${item.LOT_CODE}</td>
                                            <td class="border border-gray-300 p-2">${item.TONG_LINH}</td>
                                            <td class="border border-gray-300 p-2">${item.SO_LUONG_OK}</td>
                                            <td class="border border-gray-300 p-2">${item.SO_LUONG_NG}</td>
                                            <td class="border border-gray-300 p-2">${item.CHO_MUON}</td>
                                            <td class="border border-gray-300 p-2">${item.DA_BAO_PHE}</td>
                                            <td class="border border-gray-300 p-2">${item.ESD}</td>
                                            <td class="border border-gray-300 p-2">${item.LOCATION}</td>
                                            <td class="border border-gray-300 p-2">${item.REMARK}</td>
                                        `;
                        materialTableBody.appendChild(row);
                    });

                } catch (error) {
                    alert(`Đã xảy ra lỗi: ${error.message}`);
                }
            }
        </script>
}

